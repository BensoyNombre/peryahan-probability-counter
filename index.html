<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pocket Predictor ML</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#bb86fc">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #121212;
  color: white;
  text-align: center;
}
header {
  padding: 15px;
  font-size: 24px;
  font-weight: bold;
}
#throw-buttons {
  margin: 10px 0;
}
button.card {
  padding: 14px 18px;
  margin: 6px;
  background: #1e1e1e;
  color: white;
  border: none;
  font-size: 20px;
  border-radius: 12px;
  min-width: 60px;
  box-shadow: 0 2px 5px #000;
}
button.card.selected {
  background: #bb86fc;
  color: black;
  transform: scale(1.05);
  transition: 0.1s;
}
#confirm {
  display: none;
  background: #03dac6;
  color: black;
  padding: 12px 20px;
  font-size: 18px;
  border-radius: 12px;
  margin-top: 10px;
  box-shadow: 0 2px 5px #000;
}
#reset {
  position: fixed;
  bottom: 15px;
  left: 15px;
  background: #cf6679;
  color: white;
  padding: 10px 16px;
  font-size: 16px;
  border-radius: 12px;
  box-shadow: 0 2px 5px #000;
  z-index: 999;
}
canvas {
  max-width: 95%;
  margin: 20px auto;
  display: block;
  border-radius: 12px;
}
small {
  display: block;
  margin-top: 5px;
  opacity: 0.7;
}
#popup {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #1e1e1e;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 20px #bb86fc;
  display: none;
  z-index: 1000;
}
#popup h3 {
  margin: 0 0 10px 0;
}
#popup button {
  margin-top: 10px;
  background: #bb86fc;
  border-radius: 12px;
  padding: 8px 12px;
  font-size: 16px;
}
</style>
</head>

<body>
<header>ðŸŽ¯ Pocket Predictor ML</header>

<div id="throw-buttons">
  <p>Tap 3 cards for this throw (duplicates allowed):</p>
  <div id="card-buttons"></div>
  <button id="confirm" onclick="confirmThrow()">Confirm Throw</button>
</div>

<canvas id="pieChart"></canvas>
<small>Pie chart shows predicted probability per card</small>
<button id="reset" onclick="resetHistory()">Reset History</button>

<div id="popup">
  <h3>Top 3 Predicted Next Cards</h3>
  <div id="top3"></div>
  <button onclick="closePopup()">Close</button>
</div>

<!-- Optional Sounds -->
<audio id="tapSound" src="tap.mp3"></audio>
<audio id="confirmSound" src="confirm.mp3"></audio>
<audio id="resetSound" src="reset.mp3"></audio>

<script>
const labels = ["9","10","Jack","Queen","King","Ace"];
let history = JSON.parse(localStorage.getItem("history")) || [];
let currentThrow = [];
let cardCounts = Array(6).fill(0);

// Play sound helper
function playSound(id){ 
  const audio = document.getElementById(id);
  if(audio) audio.play().catch(()=>{}); 
}

// Calculate weighted frequency + sequence prediction
function calculateScores() {
  let scores = Array(6).fill(0);
  history.forEach((throwArr, index) => {
    throwArr.forEach(card => {
      let weight = 1 + index/10;
      scores[card] += weight;
    });
  });
  if(history.length>0){
    let lastThrow = history[history.length-1].join(',');
    history.forEach((throwArr, idx)=>{
      if(idx<history.length-1){
        let seq = throwArr.join(',');
        if(seq===lastThrow){
          history[idx+1].forEach(c=>scores[c]+=2);
        }
      }
    });
  }
  return scores;
}

// Render Pie Chart
function renderPie(){
  const ctx = document.getElementById('pieChart').getContext('2d');
  const scores = calculateScores();
  if(window.pie) window.pie.destroy();
  window.pie = new Chart(ctx,{
    type:'pie',
    data:{
      labels: labels,
      datasets:[{
        label:'Predicted probability',
        data:scores,
        backgroundColor:['#ff6384','#36a2eb','#ffcd56','#bb86fc','#03dac6','#cf6679']
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{position:'bottom',labels:{color:'white'}},
        tooltip:{
          callbacks:{
            label:function(context){
              let sum = context.dataset.data.reduce((a,b)=>a+b,0);
              let val = context.raw;
              let percent = ((val/sum)*100).toFixed(1);
              return `${context.label}: ${val.toFixed(1)} (${percent}%)`;
            }
          }
        },
        datalabels:{
          color:'white',
          formatter:function(value,context){
            let sum=context.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
            let percent=((value/sum)*100).toFixed(1);
            return percent+'%';
          },
          font:{weight:'bold',size:14}
        }
      }
    },
    plugins:[ChartDataLabels]
  });
}

// Top 3 prediction popup
function showTop3Popup(){
  const scores = calculateScores();
  let arr = scores.map((v,i)=>({card:labels[i],score:v}));
  arr.sort((a,b)=>b.score-b.score);
  let top3 = arr.slice(0,3);
  const container = document.getElementById("top3");
  container.innerHTML = top3.map(c=>`<p>${c.card} (${c.score.toFixed(1)})</p>`).join('');
  document.getElementById("popup").style.display="block";
}

function closePopup(){ document.getElementById("popup").style.display="none"; }

// Tap card input
function addCard(index){
  if(currentThrow.length>=3) return;
  currentThrow.push(index);
  cardCounts[index]++;
  const btn = document.querySelectorAll('button.card')[index];
  btn.classList.add('selected');
  btn.innerText = cardCounts[index]>1?labels[index]+' x'+cardCounts[index]:labels[index];
  playSound('tapSound');
  if(currentThrow.length===3) document.getElementById("confirm").style.display="inline-block";
}

// Confirm throw
function confirmThrow(){
  history.push([...currentThrow]);
  localStorage.setItem("history",JSON.stringify(history));
  currentThrow=[];
  cardCounts=Array(6).fill(0);
  document.querySelectorAll('button.card').forEach((b,i)=>{
    b.classList.remove('selected');
    b.innerText = labels[i];
  });
  document.getElementById("confirm").style.display="none";
  playSound('confirmSound');
  renderPie();
  showTop3Popup();
}

// Reset history
function resetHistory(){
  if(confirm("Are you sure you want to reset history?")){
    history=[];
    localStorage.setItem("history",JSON.stringify(history));
    renderPie();
    playSound('resetSound');
  }
}

// Render card buttons
function renderButtons(){
  const container=document.getElementById('card-buttons');
  container.innerHTML='';
  labels.forEach((lbl,i)=>{
    const btn=document.createElement('button');
    btn.innerText=lbl;
    btn.className='card';
    btn.onclick=()=>addCard(i);
    container.appendChild(btn);
  });
}

renderButtons();
renderPie();
</script>
</body>
</html>